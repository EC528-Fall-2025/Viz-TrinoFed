import{j as e}from"./jsx-runtime-BjG_zV1W.js";import{r as p}from"./index-DpTt3J-R.js";import{C as J}from"./CopyPaste-DTzCTJyw.js";import{d as V,c as X}from"./fixtures-BzLkDzPP.js";import"./createSvgIcon-HbE4gxjg.js";const Y=768,j=t=>{if(!t)return"0 B";const i=t/1024;if(i<1024)return`${i.toFixed(2)} KB`;const a=i/1024;return a<1024?`${a.toFixed(2)} MB`:`${(a/1024).toFixed(2)} GB`},T=t=>t==null?"N/A":t.toLocaleString(),x=t=>{if(t==null||Number.isNaN(t)||t<0)return"N/A";if(t<1)return`${Math.round(t*1e3)}ms`;if(t<60)return`${t.toFixed(2)}s`;const i=Math.floor(t/60),a=(t%60).toFixed(2);return`${i}m ${a}s`},R=t=>t?new Date(t).toLocaleString():"N/A",Z=t=>{let i=0,a=0,c=0,m=0,h,u,y;const b=new Set,M=new Set;return t.forEach(s=>{s.cpuTimeMs&&(i+=s.cpuTimeMs),s.wallTimeMs&&(a+=s.wallTimeMs),s.queuedTimeMs&&(c+=s.queuedTimeMs),s.peakMemoryBytes&&s.peakMemoryBytes>m&&(m=s.peakMemoryBytes),s.totalRows!==null&&s.totalRows!==void 0&&(h=s.totalRows),s.totalBytes!==null&&s.totalBytes!==void 0&&(u=s.totalBytes),s.completedSplits!==null&&s.completedSplits!==void 0&&(y=s.completedSplits),s.catalog&&b.add(s.catalog),s.schema&&M.add(s.schema)}),{cpuTimeMs:i>0?i:void 0,wallTimeMs:a>0?a:void 0,queuedTimeMs:c>0?c:void 0,peakMemory:m>0?m:void 0,totalRows:h,totalBytes:u,completedSplits:y,catalogs:Array.from(b),schemas:Array.from(M)}},n=({label:t,icon:i,value:a,testId:c})=>e.jsxs("div",{"data-testid":c,style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"6px",padding:"4px 0",borderBottom:"1px solid rgba(0,0,0,0.05)",fontSize:"11px",color:"#212529"},children:[e.jsxs("span",{style:{color:"#6c757d"},children:[e.jsx("span",{style:{marginRight:"6px"},children:i}),t]}),e.jsx("span",{style:{fontWeight:600},children:a})]}),f=({icon:t,title:i,children:a})=>e.jsxs("div",{style:{marginBottom:"14px"},children:[e.jsxs("div",{style:{fontWeight:600,fontSize:"12px",marginBottom:"8px",color:"#495057",borderBottom:"2px solid #e9ecef",paddingBottom:"5px",display:"flex",alignItems:"center",gap:"6px"},children:[e.jsx("span",{children:t}),e.jsx("span",{children:i})]}),a]}),W=({query:t,activeFragment:i,isOpen:a,onClose:c,onOpen:m})=>{var C,D;const h=p.useRef(null),[u,y]=p.useState(0),[b,M]=p.useState(!1),[s,P]=p.useState(!1);p.useEffect(()=>{if(typeof window>"u")return;const o=window.matchMedia(`(max-width: ${Y}px)`),d=B=>P(B);d(o.matches);const S=B=>d(B.matches);return o.addEventListener?(o.addEventListener("change",S),()=>o.removeEventListener("change",S)):(o.addListener(S),()=>o.removeListener(S))},[]);const g=p.useMemo(()=>{var o;return((o=t.events)==null?void 0:o.filter(d=>d.statistics))??[]},[t.events]);p.useEffect(()=>{u>=g.length&&y(0)},[g,u]);const w=g[u]??null,l=(w==null?void 0:w.statistics)??null,r=p.useMemo(()=>Z(t.events??[]),[t.events]),N=p.useMemo(()=>{var o;return((o=t.events)==null?void 0:o.find(d=>d.eventType==="COMPLETED"))??null},[t]),k=N?((C=N.statistics)==null?void 0:C.cpuTime)??(N.cpuTimeMs??0)/1e3:null,$=k!=null?x(k):"N/A",L=r.wallTimeMs!=null?x(r.wallTimeMs/1e3):"N/A",U=r.queuedTimeMs!=null?x(r.queuedTimeMs/1e3):"N/A",Q=t.totalExecutionTime!=null?`${t.totalExecutionTime}ms`:"N/A",H=typeof(i==null?void 0:i.rows)=="number"?i.rows.toLocaleString():"N/A",O=r.totalBytes!=null?j(r.totalBytes):"N/A",_=r.totalRows!=null?T(r.totalRows):"N/A",I=l!=null&&l.peakUserMemoryBytes?j(l.peakUserMemoryBytes):r.peakMemory?j(r.peakMemory):"N/A",G=t.startTime&&t.endTime?(new Date(t.endTime).getTime()-new Date(t.startTime).getTime())/1e3:null,K=x(G),F=`metrics-side-panel ${s?"is-mobile-drawer":"is-desktop-panel"} ${a?"is-open":"is-closed"}`;return e.jsxs(e.Fragment,{children:[s&&e.jsx("button",{type:"button","data-testid":"open-panel-button",onClick:()=>m==null?void 0:m(),style:{position:"fixed",bottom:16,right:16,zIndex:11,backgroundColor:"#1976d2",color:"#fff",border:"none",padding:"10px 18px",borderRadius:999,boxShadow:"0 2px 8px rgba(0,0,0,0.25)",cursor:"pointer",fontSize:"14px",fontWeight:600},children:"Metrics"}),e.jsxs("div",{ref:h,"data-testid":"metrics-side-panel",className:F,"aria-hidden":!a,style:{position:"absolute",top:s?16:10,left:s?void 0:10,right:s?16:void 0,zIndex:10,backgroundColor:"white",padding:"14px 18px",borderRadius:"12px",boxShadow:"0 4px 16px rgba(0,0,0,0.15)",maxWidth:s?"calc(100% - 32px)":"550px",width:s?"calc(100% - 32px)":void 0,maxHeight:"90vh",overflow:"auto",fontSize:"12px",borderLeft:`5px solid ${t.state==="FINISHED"?"#51cf66":t.errorMessage?"#ff6b6b":t.state==="RUNNING"?"#ffd43b":"#74c0fc"}`,display:a?"block":"none"},children:[c&&e.jsx("button",{type:"button","data-testid":"close-button","aria-label":"Close metrics panel",onClick:()=>c(),style:{position:"absolute",top:8,right:8,border:"none",background:"transparent",fontSize:"18px",cursor:"pointer",color:"#6c757d",padding:4},children:"Ã—"}),e.jsx(J,{copyParentContent:!0,parentRef:h,style:{position:"absolute",top:8,left:8,zIndex:20}}),e.jsxs("div",{style:{fontWeight:"bold",marginBottom:"12px",marginRight:"10px",fontSize:"17px",color:"#212529",display:"flex",alignItems:"center",justifyContent:"space-between"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"8px",margin:"10px"},children:[e.jsx("span",{children:"ðŸ“Š"}),e.jsx("span",{children:"Query Metrics & Statistics"})]}),e.jsx("span",{style:{color:t.state==="FINISHED"?"#2b8a3e":t.errorMessage?"#c92a2a":t.state==="RUNNING"?"#f08c00":"#1971c2",fontWeight:"bold",backgroundColor:t.state==="FINISHED"?"#d3f9d8":t.errorMessage?"#ffe3e3":t.state==="RUNNING"?"#fff3bf":"#d0ebff",padding:"5px 10px",borderRadius:"6px",fontSize:"11px",margin:"10px",display:"inline-block"},children:t.state})]}),e.jsxs("div",{"data-testid":"fragment-id",style:{fontWeight:600,fontSize:"13px",color:"#495057",marginBottom:"10px"},children:["Fragment: ",i?i.id:"None selected"]}),e.jsxs(f,{icon:"ðŸ“",title:"Basic Information",children:[e.jsx(n,{icon:"ðŸ”‘",label:"Query ID",value:t.queryId??"N/A"}),e.jsx(n,{icon:"ðŸ‘¤",label:"User",value:t.user??"N/A"}),e.jsx(n,{icon:"ðŸ“",label:"Event Count",value:T(((D=t.events)==null?void 0:D.length)??0)}),e.jsx(n,{icon:"ðŸ•",label:"Start Time",value:R(t.startTime)}),e.jsx(n,{icon:"ðŸ•‘",label:"End Time",value:R(t.endTime)}),e.jsx(n,{icon:"â±ï¸",label:"Duration",value:K})]}),i&&e.jsxs(f,{icon:"ðŸ§©",title:"Fragment Snapshot",children:[e.jsx(n,{icon:"ðŸ› ï¸",label:"Stage",value:i.stage??"N/A"}),e.jsx(n,{icon:"ðŸ·ï¸",label:"Status",value:i.status??"unknown"}),e.jsx(n,{icon:"ðŸ“¥",label:"Input Rows",value:H,testId:"metric-input-rows"}),e.jsx(n,{icon:"â±ï¸",label:"Duration",value:typeof i.durationMs=="number"?`${i.durationMs}ms`:"N/A"})]}),g.length>0&&e.jsx("div",{style:{marginBottom:"14px"},children:g.length>1&&e.jsxs("div",{style:{marginBottom:"10px"},children:[e.jsx("div",{style:{fontSize:"10px",color:"#6c757d",marginBottom:"5px"},children:"Select Event for Detailed Statistics"}),e.jsx("select",{value:u,onChange:o=>y(Number(o.target.value)),style:{width:"100%",padding:"6px",borderRadius:"5px",border:"1px solid #dee2e6",fontSize:"11px",backgroundColor:"white"},children:g.map((o,d)=>e.jsxs("option",{value:d,children:[o.eventType," - ",o.state," (",o.timestamp,")"]},d))})]})}),l&&e.jsxs(f,{icon:"ðŸ“Š",title:"Instant Metrics",children:[e.jsx(n,{icon:"ðŸ–¥ï¸",label:"CPU Time",value:x(l.cpuTime)}),e.jsx(n,{icon:"â°",label:"Wall Time",value:x(l.wallTime)}),e.jsx(n,{icon:"â³",label:"Queued Time",value:x(l.queuedTime)}),e.jsx(n,{icon:"ðŸ§ ",label:"Peak Memory",value:j(l.peakUserMemoryBytes)})]}),e.jsxs(f,{icon:"âš¡",title:"Aggregated Performance",children:[e.jsx(n,{icon:"â±ï¸",label:"Total Execution",value:Q}),e.jsx(n,{icon:"ðŸ–¥ï¸",label:"CPU Time",value:$,testId:"metric-cpu-time"}),e.jsx(n,{icon:"â°",label:"Wall Time",value:L}),e.jsx(n,{icon:"â³",label:"Queued Time",value:U}),e.jsx(n,{icon:"ðŸ§ ",label:"Peak Memory",value:I})]}),e.jsxs(f,{icon:"ðŸ’¾",title:"Data Metrics",children:[e.jsx(n,{icon:"ðŸ“Š",label:"Total Rows",value:_}),e.jsx(n,{icon:"ðŸ“¤",label:"Output Data",value:O,testId:"metric-output-bytes"}),e.jsx(n,{icon:"âœ‚ï¸",label:"Completed Splits",value:T(r.completedSplits??null)})]}),e.jsxs("div",{style:{marginBottom:"14px"},children:[e.jsxs("div",{"data-testid":"metric-group-memory",role:"button",onClick:()=>M(o=>!o),style:{fontWeight:600,fontSize:"12px",color:"#495057",borderBottom:"2px solid #e9ecef",paddingBottom:"5px",display:"flex",alignItems:"center",justifyContent:"space-between",cursor:"pointer"},children:[e.jsx("span",{children:"Memory Metrics"}),e.jsx("span",{children:b?"â–²":"â–¼"})]}),b&&e.jsxs("div",{style:{marginTop:"8px"},children:[e.jsx(n,{icon:"ðŸ§ ",label:"Peak Memory",value:I,testId:"metric-peak-memory"}),e.jsx(n,{icon:"ðŸ—„ï¸",label:"Peak Task Memory",value:l!=null&&l.peakTaskTotalMemory?j(l.peakTaskTotalMemory):"N/A"})]})]}),(l==null?void 0:l.operatorSummaries)&&l.operatorSummaries.length>0&&e.jsx(f,{icon:"âš™ï¸",title:"Operator Summaries",children:e.jsx("div",{style:{maxHeight:"240px",overflow:"auto"},children:l.operatorSummaries.slice(0,8).map((o,d)=>e.jsxs("div",{style:{padding:"8px",marginBottom:"6px",backgroundColor:"#f8f9fa",borderRadius:"5px",borderLeft:"3px solid #1971c2",fontSize:"10px"},children:[e.jsxs("div",{style:{fontWeight:"bold",color:"#212529",marginBottom:"4px"},children:[o.operatorType||`Operator ${d+1}`,o.planNodeId&&e.jsxs("span",{style:{color:"#6c757d",marginLeft:"6px",fontWeight:400},children:["(Node: ",o.planNodeId,")"]})]}),e.jsxs("div",{style:{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"5px",fontSize:"9px"},children:[e.jsxs("span",{children:[e.jsx("strong",{children:"Input:"})," ",T(o.inputPositions)," rows"]}),e.jsxs("span",{children:[e.jsx("strong",{children:"Output:"})," ",T(o.outputPositions)," rows"]})]})]},d))})}),(r.catalogs.length>0||r.schemas.length>0)&&e.jsxs(f,{icon:"ðŸ—‚ï¸",title:"Catalogs & Schemas",children:[r.catalogs.length>0&&e.jsxs("div",{style:{marginBottom:"8px"},children:[e.jsx("div",{style:{fontSize:"11px",fontWeight:600,marginBottom:"4px",color:"#495057"},children:"Catalogs"}),e.jsx("div",{style:{display:"flex",gap:"6px",flexWrap:"wrap"},children:r.catalogs.map(o=>e.jsx("span",{style:{backgroundColor:"#e9ecef",padding:"4px 8px",borderRadius:"12px",fontSize:"10px",fontWeight:600,color:"#495057"},children:o},o))})]}),r.schemas.length>0&&e.jsxs("div",{children:[e.jsx("div",{style:{fontSize:"11px",fontWeight:600,marginBottom:"4px",color:"#495057"},children:"Schemas"}),e.jsx("div",{style:{display:"flex",gap:"6px",flexWrap:"wrap"},children:r.schemas.map(o=>e.jsx("span",{style:{backgroundColor:"#f1f3f5",padding:"4px 8px",borderRadius:"12px",fontSize:"10px",fontWeight:600,color:"#495057"},children:o},o))})]})]})]})]})};W.__docgenInfo={description:"",methods:[],displayName:"UnifiedMetricsPanel",props:{query:{required:!0,tsType:{name:"QueryTree"},description:""},activeFragment:{required:!1,tsType:{name:"union",raw:"QueryNodeData | null",elements:[{name:"QueryNodeData"},{name:"null"}]},description:""},isOpen:{required:!0,tsType:{name:"boolean"},description:""},onClose:{required:!1,tsType:{name:"signature",type:"function",raw:"() => void",signature:{arguments:[],return:{name:"void"}}},description:""},onOpen:{required:!1,tsType:{name:"signature",type:"function",raw:"() => void",signature:{arguments:[],return:{name:"void"}}},description:""}}};const ie={title:"Components/UnifiedMetricsPanel",component:W,decorators:[t=>e.jsx("div",{style:{position:"relative",width:"100%",minHeight:"700px",backgroundColor:"#f1f3f5",padding:"2rem"},children:e.jsx(t,{})})],args:{query:X,activeFragment:V,isOpen:!0,onClose:()=>{},onOpen:()=>{}}},v={};var E,A,z;v.parameters={...v.parameters,docs:{...(E=v.parameters)==null?void 0:E.docs,source:{originalSource:"{}",...(z=(A=v.parameters)==null?void 0:A.docs)==null?void 0:z.source}}};const ne=["Default"];export{v as Default,ne as __namedExportsOrder,ie as default};
